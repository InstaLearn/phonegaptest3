YUI.add("moodle-format_socialwall-postform",function(e,t){M.format_socialwall=M.format_socialwall||{},M.format_socialwall.postforminit=function(t){"use strict";function s(t,n,r){var s=M.cfg.wwwroot+"/course/format/socialwall/ajax.php",o=M.util.add_spinner(e,n),u={method:"POST",on:{start:function(){o.show()},success:function(t,n){try{var i=e.JSON.parse(n.responseText);i.error==0?r(i):alert(i.error),o.hide()}catch(s){alert("parsefailed"),o.hide()}},failure:function(){i=!1,o.hide()}}};t.data&&(u.data=t.data),t.form&&(u.form=t.form),e.io(s,u)}function o(e){var n={};n.id=t.courseid,n.action="likepost",n.postid=e.get("id").split("_")[1],n.userlike=Number(e.hasClass("like")),n.sesskey=M.cfg.sesskey,s({data:n},e,function(e){u(e)})}function u(t){var n=e.one("#userlike_"+t.postid);t.userlike=="1"?(n.replaceClass("like","likenomore"),n.setHTML(M.str.format_socialwall.likenomore)):(n.replaceClass("likenomore","like"),n.setHTML(M.str.format_socialwall.like)),p(t)}function a(){var e={};e.id=t.courseid,e.action="loadmoreposts",e.sesskey=M.cfg.sesskey,e.limitfrom=t.postsloaded,s({data:e},r,function(e){f(e)})}function f(n){var s=e.Node.create(n.postshtml);r.insert(s,"before"),t.postsloaded=n.postsloaded,t.poststotal=n.poststotal;var o=M.str.format_socialwall.counttotalpost.replace("{$a->count}",t.postsloaded).replace("{$a->total}",t.poststotal);e.one("#counttotalpost").setHTML(o),i=!1}function l(e){var n={};n.id=t.courseid,n.action="lockpost",n.sesskey=M.cfg.sesskey,n.postid=e.get("id").split("_")[1],n.locked=Number(!e.hasClass("locked")),s({data:n},e,function(e){c(e)})}function c(t){var n=e.one("#showcommentform_"+t.postid),r=e.one("#lockpost_"+t.postid),i=r.one("*");t.locked=="1"?(n.hide(),e.one("#tlcommentformwrap_"+t.postid).hide(),r.replaceClass("unlocked","locked"),i.set("src",M.util.image_url("lockedpost","format_socialwall"))):(n.show(),r.replaceClass("locked","unlocked"),M.util.image_url("unlockedpost","format_socialwall"),i.set("src",M.util.image_url("unlockedpost","format_socialwall")))}function h(t){var n=t.get("id").split("_")[1],r=e.one("#commenttext_"+n).get("value");if(!r)return alert(M.str.format_socialwall.textrequired),!1;var i={id:"tlcommentform_"+n,useDisabled:!0};s({form:i},t,function(e){d(e)})}function p(t){var n=e.one("#tlcountcomments_"+t.postid);n&&n.setHTML(M.str.format_socialwall.countcomments.replace("{$a}",t.countcomments));var r=e.one("#tlcountlikes_"+t.postid);r&&r.setHTML(M.str.format_socialwall.countlikes.replace("{$a}",t.countlikes))}function d(t){e.one("#commenttext_"+t.postid).set("value",""),e.one("#tlcommentformwrap_"+t.postid).hide();var n=e.Node.create(t.commenthtml);e.one("#tlcomments_"+t.postid).prepend(n),p(t)}function v(e){var n={};n.id=t.courseid,n.action="showallcomments",n.sesskey=M.cfg.sesskey,n.postid=e.get("id").split("_")[1],s({data:n},e,function(e){m(e)})}function m(t){e.one("#tlcomments_"+t.postid).setHTML(t.commentshtml),e.one("#tlshowall_"+t.postid).hide()}function g(e){var n={};n.id=t.courseid,n.action="deletecomment",n.sesskey=M.cfg.sesskey,n.cid=e.get("id").split("_")[1],s({data:n},e,function(e){b(e)})}function y(e){var t=new M.core.confirm({title:M.util.get_string("confirm","moodle"),question:M.util.get_string("confirmdeletecomment","format_socialwall"),yesLabel:M.util.get_string("yes","moodle"),noLabel:M.util.get_string("cancel","moodle")});t.on("complete-yes",function(){t.hide(),t.destroy(),g(e)}),t.show()}function b(t){e.one("#tlcomment_"+t.commentid).remove(!0),p(t)}function w(){e.one("#externalurlwrapper").show(),n.hide();var t=e.one("#loadfilemanager");t&&t.set("value","0")}function E(){e.one("#externalurlwrapper").hide(),n.show();var t=e.one("#loadfilemanager");t&&t.set("value","1")}function S(){var t=e.one("#section-2");if(!t)return!1;var n=[];t.all('li[id^="module-"]').each(function(e){n[n.length]=e.get("id").split("-")[1]});var r=n.join(",");return e.one("#cmsequence").set("value",r),!0}function x(){var e=window.innerHeight-(r.getY()-window.pageYOffset);!i&&e>50&&t.postsloaded<t.poststotal&&(i=!0,a())}function T(n){var r={};r.posttext=e.one("#posttext").get("value"),r.togroupid=e.one("#id_togroupid").get("value");var i=e.one("#id_poststatus");i?r.poststatus=i.get("value"):r.poststatus=0,r.id=t.courseid,r.action="storeformparams",r.sesskey=M.cfg.sesskey;var s=M.cfg.wwwroot+"/course/format/socialwall/ajax.php";e.io(s,{data:r,sync:n})}function N(){e.one("#tl-posts").delegate("click",function(e){e.preventDefault(),l(e.currentTarget)},'a[id^="lockpost_"]'),e.one("#tl-posts").delegate("click",function(e){e.preventDefault(),o(e.target)},'a[id^="userlike_"]'),e.one("#tl-posts").delegate("click",function(e){e.preventDefault(),h(e.target)},'input[id^="postcomment_"]'),e.one("#tl-posts").delegate("click",function(e){e.preventDefault(),v(e.target)},'a[id^="tlshowall_"]'),e.one("#tl-posts").delegate("click",function(e){e.preventDefault(),y(e.currentTarget)},'a[id^="tldeletecomment_"]'),e.one("#tl-posts").delegate("click",function(t){t.preventDefault();var n=t.target.get("id").split("_")[1];e.one("#tlcommentformwrap_"+n).show()},'a[id^="showcommentform_"]');var t=e.one("#addalink");t&&t.on("click",function(e){e.preventDefault(),w()}),n=e.one("#fileswrapper"),n&&e.one("#uploadfile").on("click",function(e){e.preventDefault(),E()}),e.one("#id_submitbutton").on("click",function(){S()}),r=e.one("#tl-endofposts"),e.on("scroll",function(){x()}),window.onbeforeunload=null,e.all(".section-modchooser-link").on("click",function(){T(!1)});var i=e.one("#posttext");i&&i.on("change",function(){T(!1)}),e.one("#id_togroupid").on("change",function(){T(!1)}),e.one("#id_poststatus").on("change",function(){T(!1)})}var n,r,i=!1;N()}},"@VERSION@",{requires:["base","node","io-form","moodle-core-notification-confirm"]});
