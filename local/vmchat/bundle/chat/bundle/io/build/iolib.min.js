/*
  2014 Pinky Sharma  {@link http://vidyamantra.com}
 @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/
var io={cfg:{},sock:null,wsuri:null,response:{},auth:!1,error:null,uniquesids:null,init:function(b,a){this.cfg=b;this.wsconnect()},wsconnect:function(){io.wsuri="wss://"+this.cfg.rid;console.log(this.cfg.rid);"WebSocket"in window?this.sock=new WebSocket(io.wsuri):"MozWebSocket"in window?this.sock=new MozWebSocket(io.wsuri):(console.log("Browser does not support WebSocket!"),this.error=lang.wserror);var b=this;this.sock.onopen=function(){console.log("Connected to "+b.cfg.rid);$.event.trigger({type:"connectionopen"});
b.userauthenticat();b.addclient()};this.sock.binaryType="arraybuffer";this.sock.onmessage=function(a){try{a.data instanceof ArrayBuffer&&console.log(a.data);var c=JSON.parse(a.data);if("joinroom"==c.type){console.log("New user join room "+c.users);var e=null;null!=b.uniquesids&&$.each(c.clientids,function(a,c){void 0==b.uniquesids[a]&&(e=a)});b.uniquesids=c.clientids;$.event.trigger({type:"member_added",message:c.users,newuser:e})}if("broadcastToAll"==c.type){console.log("json  : display msg");var d=
"";void 0!=c.userto&&(d=c.userto);$.event.trigger({type:"newmessage",message:c.m,fromUser:c.user,toUser:d})}"userleft"==c.type&&(console.log("user logout"),d="",void 0!=c.userto&&(d=c.userto),null!=b.uniquesids&&delete b.uniquesids[c.user.userid],$.event.trigger({type:"user_logout",fromUser:c.user,message:"offline",toUser:d}));"leftroom"==c.type&&(console.log("member removed"),$.event.trigger({type:"member_removed",message:c.users}));"Unauthenticated"==c.type&&(console.log("Unauthenticated user"),
$.event.trigger({type:"authentication_failed",message:"Authentication failed"}));"Multiple_login"==c.type&&(console.log("Multiple_login"),$.event.trigger({type:"Multiple_login"}))}catch(f){console.log("Error catched   : "+f),$.event.trigger({type:"error",message:f})}};this.sock.onerror=function(a){b.error=a;console.log("Error:"+a);$.event.trigger({type:"error",message:a})};this.sock.onclose=function(a){console.log("Connection Closed");$.event.trigger({type:"connectionclose",message:a.reason});console.log("Connection closed (wasClean = "+
a.wasClean+", code = "+a.code+", reason = '"+a.reason+"')");setTimeout(function(){b.wsconnect()},5E3)}},userauthenticat:function(){var b=JSON.stringify({cfun:"authenticate",arg:{authuser:this.cfg.authuser,authpass:this.cfg.authpass}});this.sock.send(b)},addclient:function(){var b=JSON.stringify({cfun:"joinroom",arg:{client:this.cfg.userid,roomname:this.cfg.fastchatroom_name,user:this.cfg.userobj}});this.sock.send(b)},send:function(b){var a={cfun:"broadcastToAll",arg:{msg:b}};1<arguments.length&&(a.arg.touser=
this.uniquesids[arguments[1]]);a=JSON.stringify(a);this.sock.send(a)},sendBinary:function(b){b=new ArrayBuffer(8);b=new Uint8Array(b);for(var a=0;a<b.length;a++)b[a]=a;this.sock.send(b)},disconnect:function(){this.sock.onclose=function(){};this.sock.close();console.log("i am closing this connection")}};
